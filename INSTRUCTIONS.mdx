# Client / Pool et Requ√™te SQL Native

### üí° Cr√©er un Pool et une requ√™te SQL

## üìù Tes notes

D√©taille ce que tu as appris ici,¬†sur¬†une¬†page¬†[Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Une fois que nous avons notre base de donn√©es install√©e correctement et que nous avons toutes les informations de connexion, il est possible de cr√©er un client qui va se connecter √† notre base de donn√©es.

Les connexions base de donn√©es n√©cessitent une ouverture de connexion et une fermeture.

### Exemple avec avec [Vercel Postgres](https://vercel.com/docs/storage/vercel-postgres/sdk) :

```tsx
import {createClient} from '@vercel/postgres'

async function queryPosts() {
  const client = createClient()
  await client.connect()

  try {
    const likes = 100
    const {rows, fields} =
      await client.sql`SELECT * FROM posts WHERE likes > ${likes};`
  } finally {
    await client.end()
  }
}
```

`Vercel` nous simplifie cette t√¢che-l√† en utilisant `sql`

Il se base sur une variable d‚Äôenvironnement (`process.env.POSTGRES_URL`) pour cr√©er un client / pool de connexion.

üìë Le lien vers la doc : [https://vercel.com/docs/storage/vercel-postgres/sdk#sql](https://vercel.com/docs/storage/vercel-postgres/sdk#sql)

Cela simplifie grandement l‚Äô√©criture de `RSC` :

```tsx
import {sql} from '@vercel/postgres'

export default async function Cart({
  params,
}: {
  params: {user: string}
}): Promise<JSX.Element> {
  const {rows} = await sql`SELECT * from CARTS where user_id=${params.user}`

  return (
    <div>
      {rows.map((row) => (
        <div key={row.id}>
          {row.id} - {row.quantity}
        </div>
      ))}
    </div>
  )
}
```

### Exemple avec avec [Node-Postges](https://orm.drizzle.team/docs/get-started-postgresql#node-postgres) :

- Cr√©ation du client :

```tsx
import {Client} from 'pg'

const client = new Client({
  connectionString: 'postgres://user:password@host:port/db',
})
// or
const client = new Client({
  host: '127.0.0.1',
  port: 5432,
  user: 'postgres',
  password: 'password',
  database: 'db_name',
})

//connexion
await client.connect()
//fermeture
await client.end()
```

Faire une requ√™te :

```tsx
const {rows} = await client.query<User>(`SELECT id,
    name,
    createdat AS "createdAt",
    updatedat AS "updatedAt" from User`)
```

### POOL de connexions

Maintenir une connexion est co√ªteux en ressources et difficile √† g√©rer. Dans une application, il est parfois n√©cessaire d‚Äôavoir de multiples connexions pour que l‚Äôapplication soit efficace.

Un pool de connexions est un m√©canisme qui g√®re efficacement les connexions √† une base de donn√©es en maintenant un ensemble de connexions ouvertes pour √™tre r√©utilis√©es par diff√©rentes requ√™tes. Cela √©vite le co√ªt de cr√©er et fermer une nouvelle connexion √† chaque requ√™te, am√©liorant ainsi les performances de l'application. Il permet aussi de limiter et d'optimiser l'utilisation des ressources en contr√¥lant le nombre de connexions simultan√©es.

### Initialisation de la BDD

Comme notre BDD est vierge, nous allons cr√©er une table `Todo` avec des donn√©es pour pouvoir faire des requ√™tes SQL dessus. Pour cela, dans le dossier `src/db/scripts` il y a des scripts utiles pour g√©rer cela.

- `create-tables.sql` : Permet de cr√©er des tables.
- `seed.sql` : Permet d‚Äôins√©rer des donn√©es.
- `drop.sql` : Permet de supprimer toutes les tables.

Nous en ajouterons d‚Äôautres par la suite.

Pour commencer, ajoutons des `Todos`

```sql
CREATE TABLE Todo (
  id SERIAL PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  isCompleted BOOLEAN NOT NULL,
  createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO Todo (title, isCompleted, createdAt, updatedAt) VALUES
('Learn TypeScript', false, '2024-01-01 10:00:00', '2024-01-01 10:00:00'),
('Build a Next.js App', false, '2024-01-02 11:00:00', '2024-01-02 11:00:00'),
('Write a Blog Post', true, '2024-01-03 09:00:00', '2024-01-03 09:00:00'),
('Create a YouTube Video', false, '2024-01-04 14:00:00', '2024-01-04 14:00:00'),
('Read a Technical Book', true, '2024-01-05 08:00:00', '2024-01-05 08:00:00'),
('Update Portfolio', false, '2024-01-06 15:00:00', '2024-01-06 15:00:00'),
('Attend a Webinar', true, '2024-01-07 12:00:00', '2024-01-07 12:00:00'),
('Practice Coding Challenges', false, '2024-01-08 17:00:00', '2024-01-08 17:00:00'),
('Network with Peers', false, '2024-01-09 13:00:00', '2024-01-09 13:00:00'),
('Plan Next Month‚Äôs Goals', true, '2024-01-10 18:00:00', '2024-01-10 18:00:00');
```

<aside>
üí° Cette requ√™te fonctionne en local ou sur `Vercel`

</aside>

Dans cet exercice, nous allons essayer les deux approches : En local et en h√©berg√© sur `Vercel`. Une fois la connexion √©tablie sur un serveur. Le reste des exercices devrait √™tre transparents.

## Exercice

### Base de donn√©es locale

Dans cet exercice, tu vas devoir cr√©er un client qui va se connecter vers la base de donn√©es et r√©cup√©rer les `Todo`. Tu vas devoir :

- Utiliser le client `pg`
- Cr√©er une instance.
- Ouvrir la connexion.
- Ex√©cuter la requ√™te SQL.
- Fermer la connexion.

```tsx
import {Client} from 'pg'
```

Fichiers

- `exercise/client-pool/page`

## Bonus

### 1. üöÄ Cr√©er un Pool de connexion

Il est pr√©f√©rable d‚Äôutiliser un pool de connexion pour plus de simplicit√© et d‚Äôefficacit√©.

Notre librairie nous permet de g√©rer cela avec :

```tsx
import {Pool} from 'pg'

const pool = new Pool({
  connectionString:
    'postgres://postgres:postgres@localhost:5432/postgres?sslmode=disable',
})
```

**üê∂** Adapte le code pour utiliser un Pool de connexion

- Instancie `new Pool`
- Supprime les connexions et d√©connections car elles ne sont plus utiles

Fichiers

- `exercise/client-pool/page`

### 2. üöÄ Faire la m√™me chose avec Vercel Postgree

Si ta base de donn√©es est sur `Vercel`, il va falloir utiliser la librairie `Vercel` et cr√©er un `Pool Vercel` :

```tsx
import {createPool} from '@vercel/postgres'

const pool = createPool({
  connectionString:
    'postgres://default:pass@hostname:5432/verceldb?sslmode=require',
})
```

Au lieu d‚Äôutiliser :

```tsx
//pg
const {rows} = await pool.query<Todo>(`SELECT ...`)

//vercel
const {rows} = await pool.sql<Todo>(`SELECT ...`)
```

Fichiers

- `exercise/client-pool/page`

### 3. üöÄ Variables d‚Äôenvironnement

Les adresses de connexions aux serveurs de base de donn√©es varient en fonction de l‚Äôenvironnement

- D√©veloppement.
- Production.
- Test.

Il n‚Äôest donc pas conseill√© de mettre les informations de connexion dans le code (cela pose √©galement des probl√®mes de s√©curit√©).

√Ä la place, nous utilisons des variables d‚Äôenvironnements :

- `.env.development`
- `.env.production`

### Ordre de priorit√© des fichiers `.env` dans `Next.js` :

1. **.env.local** : Ce fichier est toujours charg√©, quel que soit l'environnement (`development`, `production`, etc.). Il est utile pour stocker des variables d'environnement sp√©cifiques √† la machine locale, et ce fichier est g√©n√©ralement ignor√© par Git.
2. **.env.development** : Ce fichier est charg√© uniquement en mode d√©veloppement (`next dev`). Il contient des variables d'environnement sp√©cifiques au d√©veloppement.
3. **.env.production** : Ce fichier est charg√© uniquement en mode production (`next start`). Il contient des variables d'environnement sp√©cifiques √† la production.
4. **.env.test** : Ce fichier est charg√© uniquement en mode test (`next test` ou lors de l'ex√©cution de tests).
5. **.env** : Ce fichier est une sorte de `"fallback"` pour toutes les configurations. S'il n'existe pas de fichier sp√©cifique √† l'environnement actuel, `Next.js` utilisera les variables d√©finies dans ce fichier.

<aside>
üí° La priorit√© est toujours faite √† la variable d‚Äôenvironnement pr√©sente sur la machine.

</aside>

**üê∂** Dans cet exercice, adapte le code pour qu‚Äôil utilise la bonne variable d‚Äôenvironnement et modifie **les** fichiers **`.env`** pour contenir la connexion √† ta base de donn√©es.

Fichiers

- `exercise/client-pool/page`
- `.env.development`
- `.env.production`

PS : `Vercel` d√©tectera automatiquement les variables `POSTGRES_URL` et cr√©era le bon pool

## Aller plus loin

üìë Le lien vers la doc [https://www.w3schools.com/html/html_css.asp](https://www.w3schools.com/html/html_css.asp)

## Ils vont t‚Äôaider

- **üê∂ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ü§ñ Ash le Robot** : _Ash le Robot te donnera du code utile._
- **üöÄ Julia La roquette** : _Julia te donnera des d√©fis suppl√©mentaires._
- **‚õèÔ∏è Hulk le Marteau** : _Quand du code √† supprimer est pr√©sent_
- **üë®‚Äç‚úàÔ∏è Hugo le chef de projet** : _Va t'aider sur les sp√©cifications du projet_

## üêú Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=06.Data%20Modeling&entry.533578441=01%20Client%20Pool).
