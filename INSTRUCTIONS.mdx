# Create Read Update Delete

### ğŸ’¡ Faire un CRUD sur des produits

## ğŸ“ Tes notes

Detaille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Dans les sections prÃ©cÃ©dentes, nous avons principalement fais des requete de lectures (Query et Select).

Nous allons voir maintenant comment CrÃ©er, Mettre Ã  jour et supprimer des donnÃ©es.

**1 : CrÃ©ation de donnÃ©es**

```tsx
await db.insert(users).values({name: 'Andrew'})
// multiple row
await db.insert(users).values([{name: 'Andrew'}, {name: 'Dan'}])
```

ğŸ“‘ Le liens vers la doc https://orm.drizzle.team/docs/insert#insert-one-row

**2 : Mise Ã  jour**

```tsx
await db.update(users).set({name: 'Mr. Dan'}).where(eq(users.name, 'Dan'))
```

ğŸ“‘ Le liens vers la doc https://orm.drizzle.team/docs/update

**3 : Suppression**

```tsx
await db.delete(users).where(eq(users.name, 'Dan'))
```

ğŸ“‘ Le liens vers la doc https://orm.drizzle.team/docs/delete

## Exercice

Dans cet exercice nous avons notre page dâ€™administration de produits.

- Un tableau contenant la liste des produits
- Un formulaire permettant lâ€™ajout et lâ€™Ã©dition de produit

Le tout est dÃ©jÃ  connectÃ© aux `actions` comme nous lâ€™avons fait des les modules prÃ©cÃ©dents.

Nous allons ici nous concentrer sur les requetes dans actions.

- **ğŸ¶ ImplÃ©mente les requÃªtes :**
  - `getCategories` : Pour remplir la combobox category
  - `getProducts(catId?: number)` : Tous les produits avec un filtre optionnel sur la `category`
  - `getProductByName(name: string)`, recherche de produit par son nom, il sera utilise pour Ã©viter les doublons
  - `deleteProductDao` : La requÃªte de suppression
  - `insertProductDao` : La requÃªte dâ€™insertion
  - `updateProductDao`: La requÃªte de mise Ã  jour

<aside>
ğŸ’¡ Nous les avons renommÃ© Dao (Data AccÃ¨s Object) pour ne pas les confondre avec les fonction de lâ€™action

</aside>

```tsx
export const deleteProduct = async (product: Product) => {
  await deleteProductDao(product.id)
  revalidatePath('/exercises/crud')
}
```

Nous ne voulons pas mÃ©langer des fonctions liÃ© a la BDD et aux actions, câ€™est le principe **SRP (Single Responsibility Principle)** de clean architecture

PS : Pour simplifier lâ€™inversion, mise Ã  jour dans le formulaire nous avons crÃ©Ã© une fonction `persist` qui se base sur lâ€™id du produit

```tsx
export async function persistProductDao(product: Product) {
  await (product.id > 0 ? updateProductDao(product) : insertProductDao(product))
}
```

Fichiers

- `exercises/crud/action.tsx`

## Bonus

### 1. ğŸš€ Upsert

PrÃ©cÃ©demment nous avons gÃ©rer nous mÃªme le cas `Update` / `Insert` en faisant

```tsx
export async function persistProductDao(product: Product) {
  await (product.id > 0 ? updateProductDao(product) : insertProduct(product))
}
```

`Drizzle` permet de faire des `Upsert` (Update / Insert).

Doc : https://orm.drizzle.team/docs/insert#on-conflict-do-update

Pour fonctionner on utiliser un `insert` + `onConflictDoUpdate`

```tsx
await db
  .insert(users)
  .values({id: 1, name: 'Dan'})
  .onConflictDoUpdate({target: users.id, set: {name: 'John'}})
```

- **ğŸ¶ Adapte la fonction `persistProductDao` en utilisant cette technique**

Fichiers

- `exercises/crud/action.tsx`

###

## Aller plus loin

ğŸ“‘ Le lien vers la doc [https://orm.drizzle.team/docs/insert#with-insert-clause](https://orm.drizzle.team/docs/insert#with-insert-clause)

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=Data%20Modeling&entry.533578441=09%20CRUD%20products).
