# Client / Pool et Requête SQL Native

### 💡 Créer un Pool et une requête SQL

## 📝 Tes notes

Detaille ce que tu as appris ici, sur une page [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Une fois que nous avons notre base de données installé correctement et que nous avons toutes les informations de connexion, il est possible de créer un client qui va se connecter à notre base de données.

Les connexions base de données nécessites une ouverture de connexion et une fermeture.

### Exemple avec avec [Vercel Postgres](https://vercel.com/docs/storage/vercel-postgres/sdk)

```tsx
import { createClient } from '@vercel/postgres';

async function queryPosts() {
  const client = createClient();
  await client.connect();

  try {
    const likes = 100;
    const { rows, fields } =
      await client.sql`SELECT * FROM posts WHERE likes > ${likes};`;
  } finally {
    await client.end();
  }
}
```

`Vercel` nous simplifie cette tache la en utilisant `sql`

Il se base sur une variable d’environnement (`process.env.POSTGRES_URL`) pour creer une client / pool de connexion

📑 Le lien vers la doc : [https://vercel.com/docs/storage/vercel-postgres/sdk#sql](https://vercel.com/docs/storage/vercel-postgres/sdk#sql)

Cela simplifie grandement l’écriture de RSC

```tsx
import { sql } from "@vercel/postgres";

export default async function Cart({
  params
} : {
  params: { user: string }
}): Promise<JSX.Element> {
  const { rows } = await sql`SELECT * from CARTS where user_id=${params.user}`;

  return (
    <div>
      {rows.map((row) => (
        <div key={row.id}>
          {row.id} - {row.quantity}
        </div>
      ))}
    </div>
  );
}
```

### Exemple avec avec [Node-Postges](https://orm.drizzle.team/docs/get-started-postgresql#node-postgres)

- Création du client

```tsx
import { Client } from "pg";

const client = new Client({
  connectionString: "postgres://user:password@host:port/db",
});
// or
const client = new Client({
  host: "127.0.0.1",
  port: 5432,
  user: "postgres",
  password: "password",
  database: "db_name",
});

//connexion
await client.connect();
//fermeture
await client.end();
```

Faire une requête

```tsx
const {rows} = await client.query<User>(`SELECT id,
    name,
    createdat AS "createdAt",
    updatedat AS "updatedAt" from User`)
```

### POOL de connexions

Maintenir une connexion est couteux en ressource et difficile à gérer. Dans une application il est parfois nécessaire d’avoir de multiples connexions pour que l’application soit efficace.

Un pool de connexions est un mécanisme qui gère efficacement les connexions à une base de données en maintenant un ensemble de connexions ouvertes pour être réutilisées par différentes requêtes. Cela évite le coût de créer et fermer une nouvelle connexion à chaque requête, améliorant ainsi les performances de l'application. Il permet aussi de limiter et d'optimiser l'utilisation des ressources en contrôlant le nombre de connexions simultanées.

### Initialisation de la BDD

Comme nous BDD est vierge, nous allons créer une table `Todo` avec des données pour voir faire des requêtes SQL dessus. Pour cela dans le dossier `src/db/scripts` il y a des scripts utils pour gerer cela.

- `create-tables.sql` : Permet de créer des tables
- `seed.sql` : Permet d’insérer des données
- `drop.sql` : Permet supprimer toutes les tables

Nous en ajouterons d’autres par la suite

Pour commencer ajoutons des `Todos`

```sql
CREATE TABLE Todo (
  id SERIAL PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  isCompleted BOOLEAN NOT NULL,
  createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO Todo (title, isCompleted, createdAt, updatedAt) VALUES
('Learn TypeScript', false, '2024-01-01 10:00:00', '2024-01-01 10:00:00'),
('Build a Next.js App', false, '2024-01-02 11:00:00', '2024-01-02 11:00:00'),
('Write a Blog Post', true, '2024-01-03 09:00:00', '2024-01-03 09:00:00'),
('Create a YouTube Video', false, '2024-01-04 14:00:00', '2024-01-04 14:00:00'),
('Read a Technical Book', true, '2024-01-05 08:00:00', '2024-01-05 08:00:00'),
('Update Portfolio', false, '2024-01-06 15:00:00', '2024-01-06 15:00:00'),
('Attend a Webinar', true, '2024-01-07 12:00:00', '2024-01-07 12:00:00'),
('Practice Coding Challenges', false, '2024-01-08 17:00:00', '2024-01-08 17:00:00'),
('Network with Peers', false, '2024-01-09 13:00:00', '2024-01-09 13:00:00'),
('Plan Next Month’s Goals', true, '2024-01-10 18:00:00', '2024-01-10 18:00:00');
```

<aside>
💡 Cette requête fonctionne en local ou sur Vercel

</aside>

Dans cet exercice nous allons essayer les deux approche : En local et en hébergé sur `Vercel`. Une fois la connexion etablie sur un server. Le reste des exercices devraient être transparent

## Exercice

### Base de données local

Dans cet exercice tu vas devoir créer un client qui va se connecter vers la base de données et récupérer les `Todo`. Tu vas devoir

- Utilise le client `pg`,
- créer une instance
- Ouvrir la connexion
- Exécuter la requête SQL
- Fermer la connexion

```tsx
import {Client} from 'pg'
```

Fichiers

- `exercise/client-pool/page`

## Bonus

### 1. 🚀 Créer un Pool de connexion

Il est préférable d’utiliser un pool de connexion pour plus de simplicité et d’efficacité.

Notre librairie nous permet de gérer cela avec

```tsx
import {Pool} from 'pg'

const pool = new Pool({
    connectionString:
      'postgres://postgres:postgres@localhost:5432/postgres?sslmode=disable',
  })
```

**🐶** Adapte le code pour utiliser un Pool de connexion

- instancie `new Pool`
- Supprime les connexions et déconnections car ils ne sont plus utiles

Fichiers

- `exercise/client-pool/page`

### 2. 🚀 Faire la même chose avec Vercel Postgree

Si ta base de données est sur `Vercel` il va falloir utiliser la librairie vercel et creer un Pool Vercel

```tsx
import {createPool} from '@vercel/postgres'

const pool = createPool({
  connectionString:
    'postgres://default:pass@hostname:5432/verceldb?sslmode=require',
})
```

Au lieu d’utiliser

```tsx
//pg
const {rows} = await pool.query<Todo>(`SELECT ...`)

//vercel
const {rows} = await pool.sql<Todo>(`SELECT ...`)
```

Fichiers

- `exercise/client-pool/page`

### 2. 🚀 Variables d’environnement

Les adresses de connexions aux serveurs de base de données varient en fonction de l’environnement

- developpement
- production
- test

Il n’est donc pas conseiller de mettre les informations de connexion dans le code (cela pose également des problèmes de sécurité).

A la place nous utilisons des variables d’environnements.

- `.env.development`
- `.env.production`

### Ordre de priorité des fichiers `.env` dans Next.js :

1. **.env.local** : Ce fichier est toujours chargé, quelle que soit l'environnement (`development`, `production`, etc.). Il est utile pour stocker des variables d'environnement spécifiques à la machine locale, et ce fichier est généralement ignoré par Git.
2. **.env.development** : Ce fichier est chargé uniquement en mode développement (`next dev`). Il contient des variables d'environnement spécifiques au développement.
3. **.env.production** : Ce fichier est chargé uniquement en mode production (`next start`). Il contient des variables d'environnement spécifiques à la production.
4. **.env.test** : Ce fichier est chargé uniquement en mode test (`next test` ou lors de l'exécution de tests).
5. **.env** : Ce fichier est une sorte de "fallback" pour toutes les configurations. S'il n'existe pas de fichier spécifique à l'environnement actuel, Next.js utilisera les variables définies dans ce fichier.

<aside>
💡 La priorité est toujours faite à la variable d’environnement présente sur la machine

</aside>

**🐶 Dans cet exercice adapte le code pour qu’il utilise la bonne variable d’environnement et modifie les fichier .env pour contenir la connexion a ta base de données.**

Fichiers

- `exercise/client-pool/page`
- `.env.development`
- `.env.production`

## Aller plus loin

📑 Le lien vers la doc [https://www.w3schools.com/html/html_css.asp](https://www.w3schools.com/html/html_css.asp)

## Ils vont t’aider

- **🐶 Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **🤖 Ash le Robot** : _Ash le Robot te donnera du code utile._
- **🚀 Julia La roquette** : _Julia te donnera des défis supplémentaires._
- **⛏️ Hulk le Marteau** : _Quand du code à supprimer est présent_
- **👨‍✈️ Hugo le chef de projet** : _Va t'aider sur les spécifications du projet_

## 🐜 Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=Data%20Modeling&entry.533578441=01%20Client%20Pool).
