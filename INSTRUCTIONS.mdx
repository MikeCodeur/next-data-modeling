# ORM - ModÃ©lisation avec Drizzle

### ğŸ’¡ Initialisation et ModÃ©lisation avec Drizzle

## ğŸ“ Tes notes

DÃ©taille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Le but d'un `ORM` (`Object-Relational Mapping`) est de simplifier et d'abstraire l'interaction entre une application et une base de donnÃ©es relationnelle en permettant aux dÃ©veloppeurs de manipuler les donnÃ©es de la base de donnÃ©es sous forme d'objets dans le code, plutÃ´t que d'Ã©crire des requÃªtes SQL directement comme nous lâ€™avons fait dans les sections prÃ©cÃ©dentes.

Dans lâ€™exercice prÃ©cÃ©dent, nous avons dÃ» dÃ©finir un type TS `Todo` et autant de requÃªtes SQL que nÃ©cessaire.

```tsx
type Todo = {
  id: number
  title: string
  isCompleted: boolean
  createdAt?: Date
  updatedAt?: Date
}

await pool.sql`
    UPDATE Todo
    SET
      title = ${title},
      isCompleted = ${isCompleted},
      updatedAt = NOW()
    WHERE id = ${id}
  `
```

Le but dâ€™un `ORM` est dâ€™Ãªtre indÃ©pendant de la BDD (en thÃ©orie) et de dÃ©finir des modÃ¨les (qui correspondent Ã  des tables) que lâ€™on peut manipuler facilement dans le code.

Il existe de nombreux `ORM JS/TS` comme : `Sequelize` / `TypeORM` / `Prisma` / `Objection.js` / `MikroORM` etcâ€¦

Dans ce module, nous utiliserons `Drizzle` car il est trÃ¨s lÃ©ger et simple Ã  manipuler. Par exemple la dÃ©finition dâ€™un `User`

```tsx
export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  fullName: text('full_name'),
  phone: varchar('phone', {length: 256}),
})
```

Mise Ã  jour :

```tsx
await db.update(users).set({name: 'Mr. Dan'}).where(eq(users.name, 'Dan'))
```

Nous nâ€™avons plus besoin de gÃ©rer les requÃªtes SQL nativement. De plus, cette approche permet Ã©galement de manipuler le modÃ¨le de donnÃ©es et gÃ©rer les migrations.

ğŸ“‘ Le lien vers la doc [https://orm.drizzle.team/docs/sql-schema-declaration](https://orm.drizzle.team/docs/sql-schema-declaration)

### Initialiser Drizzle

Pour initialiser `Drizzle`, il faut plusieurs choses :

- Un client/pool de connexion.
- Des models.
- Des options.

Exemple avec `Node-Postgres` :

```tsx
import {drizzle} from 'drizzle-orm/node-postgres'
import {Pool} from 'pg'
import * as user from './users'

const pool = new Pool({
  connectionString: 'postgres://user:password@host:port/db',
})

const db = drizzle(pool, {
  schema: {...user},
})
```

Exemple avec `Vercel-Postgres` :

```tsx
import {createPool} from '@vercel/postgres'
import {drizzle} from 'drizzle-orm/vercel-postgres'
import * as user from './users'

const pool = createPool({
  connectionString: 'postgres://user:password@host:port/db',
})
const db = drizzle(pool, {
  schema: {...user},
})
```

On peut ensuite utiliser `Drizzle` pour manipuler la BDD :

```tsx
const result = await db.select().from(users)
```

**Organisation du projet**

Lâ€™organisation du projet est libre mais nous suivrons une des recommandations de la [documentation](https://orm.drizzle.team/docs/sql-schema-declaration)

![folder.png](/course/folder.png)

Pour simplifier lâ€™exercice, un fichier `src/db/schema.index.ts` contient les 2 configurations de base de donnÃ©es. Pour switcher de lâ€™une Ã  l'autre, il suffit de modifier le `boolean isVercel true/false`

- `Vercel` et `PG` :

```tsx
const pool = new Pool({
  connectionString: process.env.POSTGRES_URL_LOCAL,
})
const poolVercel = createPool({
  connectionString: process.env.POSTGRES_URL,
})

const dbPg = drizzle(pool, {
  schema: {...todos},
})
const dbVercel = drizzleVercel(poolVercel, {
  schema: {...todos},
})

const isVercel = true
const db = isVercel ? dbVercel : dbPg
export default db
```

## Exercice

Dans cet exercice, tu vas devoir modÃ©liser `Todo` . Pour Ã©viter les confusions, nous avons rendu le type `Todo` prÃ©cÃ©dent `deprecated`.

```tsx
/**
 * @deprecated Use type genereted by Drizzle Insted.
 */
export type Todo = {
  id: number
  title: string
  isCompleted: boolean
  createdAt?: Date
  updatedAt?: Date
}
```

**ğŸ¶ 1. Ã‰dite le fichier** `src/db/schema/todos.ts` pour ajouter les colonnes et leurs types. Pour rappel, voilÃ  le format de la crÃ©ation de la table :

```tsx
CREATE TABLE Todo (
  id SERIAL PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  isCompleted BOOLEAN NOT NULL,
  createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

- Pour dÃ©finir une clef primaire : https://orm.drizzle.team/docs/column-types/pg#primary-key
- Pour dÃ©finir un texte et une longueur : https://orm.drizzle.team/docs/column-types/pg#varchar
- Pour dÃ©finir un timestamp : https://orm.drizzle.team/docs/column-types/pg#timestamp

Pense Ã  :

- Mettre les valeurs par dÃ©faut.
- Exporter les types TS `Todo` et `AddTodo` grÃ¢ce Ã  [$inferSelect et $inserInsert](https://orm.drizzle.team/learn/latest-releases/drizzle-orm-v0283#-added-tableinferselect--table_inferselect-and-tableinferinsert--table_inferinsert-for-more-convenient-table-model-type-inference).

**ğŸ¶ 2. Ã‰dite le fichier `action` pour la requÃªte `getTodos`.**

- Nous allons utiliser [select](https://orm.drizzle.team/docs/select)
- Nous allons trier par id : [orderBy](https://orm.drizzle.team/docs/select#order-by)

Fichiers

- `src/db/schema/todos.ts`
- `src/exercises/drizzle-todo/action.ts`

## Bonus

### 1. ğŸš€ InsÃ©rer des donnÃ©es

ğŸ¶ Dans cet exercice bonus, tu vas devoir modifier la requÃªte `insert` native en utilisant `drizzle`. Exemple :

```tsx
await db.insert(users).values({name: 'Andrew'})
```

ğŸ“‘ Le lien vers la doc : [https://orm.drizzle.team/docs/insert](https://orm.drizzle.team/docs/insert)

PS : Retourne la valeur insÃ©rÃ©e avec [returning()](https://orm.drizzle.team/docs/insert#insert-returning)

Fichiers

- `src/exercises/drizzle-todo/action.ts`

### 2. ğŸš€ Mettre Ã  jour les donnÃ©es

ğŸ¶ Dans cet exercice bonus, tu vas devoir modifier la requÃªte `update` native en utilisant `drizzle`. Exemple :

```tsx
await db.update(users).set({name: 'Mr. Dan'}).where(eq(users.name, 'Dan'))
```

ğŸ“‘ Le lien vers la doc : [https://orm.drizzle.team/docs/update](https://orm.drizzle.team/docs/update)

Fichiers

- `src/exercises/drizzle-todo/action.ts`

## Aller plus loin

ğŸ“‘ Le lien vers la doc : [https://orm.drizzle.team/docs/](https://orm.drizzle.team/docs/update)

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=06.Data%20Modeling&entry.533578441=04%20ORM%20Drizzle).
