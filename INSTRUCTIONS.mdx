# Client / Pool et RequÃªte SQL Native

### ğŸ’¡ CrÃ©er un Pool et une requÃªte SQL

## ğŸ“ Tes notes

Detaille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Une fois que nous avons notre base de donnÃ©es installÃ© correctement et que nous avons toutes les informations de connexion, il est possible de crÃ©er un client qui va se connecter Ã  notre base de donnÃ©es.

Les connexions base de donnÃ©es nÃ©cessites une ouverture de connexion et une fermeture.

### Exemple avec avec [Vercel Postgres](https://vercel.com/docs/storage/vercel-postgres/sdk)

```tsx
import { createClient } from '@vercel/postgres';

async function queryPosts() {
  const client = createClient();
  await client.connect();

  try {
    const likes = 100;
    const { rows, fields } =
      await client.sql`SELECT * FROM posts WHERE likes > ${likes};`;
  } finally {
    await client.end();
  }
}
```

`Vercel` nous simplifie cette tache la en utilisant `sql`

Il se base sur une variable dâ€™environnement (`process.env.POSTGRES_URL`) pour creer une client / pool de connexion

ğŸ“‘ Le lien vers la doc : [https://vercel.com/docs/storage/vercel-postgres/sdk#sql](https://vercel.com/docs/storage/vercel-postgres/sdk#sql)

Cela simplifie grandement lâ€™Ã©criture de RSC

```tsx
import { sql } from "@vercel/postgres";

export default async function Cart({
  params
} : {
  params: { user: string }
}): Promise<JSX.Element> {
  const { rows } = await sql`SELECT * from CARTS where user_id=${params.user}`;

  return (
    <div>
      {rows.map((row) => (
        <div key={row.id}>
          {row.id} - {row.quantity}
        </div>
      ))}
    </div>
  );
}
```

### Exemple avec avec [Node-Postges](https://orm.drizzle.team/docs/get-started-postgresql#node-postgres)

- CrÃ©ation du client

```tsx
import { Client } from "pg";

const client = new Client({
  connectionString: "postgres://user:password@host:port/db",
});
// or
const client = new Client({
  host: "127.0.0.1",
  port: 5432,
  user: "postgres",
  password: "password",
  database: "db_name",
});

//connexion
await client.connect();
//fermeture
await client.end();
```

Faire une requÃªte

```tsx
const {rows} = await client.query<User>(`SELECT id,
    name,
    createdat AS "createdAt",
    updatedat AS "updatedAt" from User`)
```

### POOL de connexions

Maintenir une connexion est couteux en ressource et difficile Ã  gÃ©rer. Dans une application il est parfois nÃ©cessaire dâ€™avoir de multiples connexions pour que lâ€™application soit efficace.

Un pool de connexions est un mÃ©canisme qui gÃ¨re efficacement les connexions Ã  une base de donnÃ©es en maintenant un ensemble de connexions ouvertes pour Ãªtre rÃ©utilisÃ©es par diffÃ©rentes requÃªtes. Cela Ã©vite le coÃ»t de crÃ©er et fermer une nouvelle connexion Ã  chaque requÃªte, amÃ©liorant ainsi les performances de l'application. Il permet aussi de limiter et d'optimiser l'utilisation des ressources en contrÃ´lant le nombre de connexions simultanÃ©es.

### Initialisation de la BDD

Comme nous BDD est vierge, nous allons crÃ©er une table `Todo` avec des donnÃ©es pour voir faire des requÃªtes SQL dessus. Pour cela dans le dossier `src/db/scripts` il y a des scripts utils pour gerer cela.

- `create-tables.sql` : Permet de crÃ©er des tables
- `seed.sql` : Permet dâ€™insÃ©rer des donnÃ©es
- `drop.sql` : Permet supprimer toutes les tables

Nous en ajouterons dâ€™autres par la suite

Pour commencer ajoutons des `Todos`

```sql
CREATE TABLE Todo (
  id SERIAL PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  isCompleted BOOLEAN NOT NULL,
  createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO Todo (title, isCompleted, createdAt, updatedAt) VALUES
('Learn TypeScript', false, '2024-01-01 10:00:00', '2024-01-01 10:00:00'),
('Build a Next.js App', false, '2024-01-02 11:00:00', '2024-01-02 11:00:00'),
('Write a Blog Post', true, '2024-01-03 09:00:00', '2024-01-03 09:00:00'),
('Create a YouTube Video', false, '2024-01-04 14:00:00', '2024-01-04 14:00:00'),
('Read a Technical Book', true, '2024-01-05 08:00:00', '2024-01-05 08:00:00'),
('Update Portfolio', false, '2024-01-06 15:00:00', '2024-01-06 15:00:00'),
('Attend a Webinar', true, '2024-01-07 12:00:00', '2024-01-07 12:00:00'),
('Practice Coding Challenges', false, '2024-01-08 17:00:00', '2024-01-08 17:00:00'),
('Network with Peers', false, '2024-01-09 13:00:00', '2024-01-09 13:00:00'),
('Plan Next Monthâ€™s Goals', true, '2024-01-10 18:00:00', '2024-01-10 18:00:00');
```

<aside>
ğŸ’¡ Cette requÃªte fonctionne en local ou sur Vercel

</aside>

Dans cet exercice nous allons essayer les deux approche : En local et en hÃ©bergÃ© sur `Vercel`. Une fois la connexion etablie sur un server. Le reste des exercices devraient Ãªtre transparent

## Exercice

### Base de donnÃ©es local

Dans cet exercice tu vas devoir crÃ©er un client qui va se connecter vers la base de donnÃ©es et rÃ©cupÃ©rer les `Todo`. Tu vas devoir

- Utilise le client `pg`,
- crÃ©er une instance
- Ouvrir la connexion
- ExÃ©cuter la requÃªte SQL
- Fermer la connexion

```tsx
import {Client} from 'pg'
```

Fichiers

- `exercise/client-pool/page`

## Bonus

### 1. ğŸš€ CrÃ©er un Pool de connexion

Il est prÃ©fÃ©rable dâ€™utiliser un pool de connexion pour plus de simplicitÃ© et dâ€™efficacitÃ©.

Notre librairie nous permet de gÃ©rer cela avec

```tsx
import {Pool} from 'pg'

const pool = new Pool({
    connectionString:
      'postgres://postgres:postgres@localhost:5432/postgres?sslmode=disable',
  })
```

**ğŸ¶** Adapte le code pour utiliser un Pool de connexion

- instancie `new Pool`
- Supprime les connexions et dÃ©connections car ils ne sont plus utiles

Fichiers

- `exercise/client-pool/page`

### 2. ğŸš€ Faire la mÃªme chose avec Vercel Postgree

Si ta base de donnÃ©es est sur `Vercel` il va falloir utiliser la librairie vercel et creer un Pool Vercel

```tsx
import {createPool} from '@vercel/postgres'

const pool = createPool({
  connectionString:
    'postgres://default:pass@hostname:5432/verceldb?sslmode=require',
})
```

Au lieu dâ€™utiliser

```tsx
//pg
const {rows} = await pool.query<Todo>(`SELECT ...`)

//vercel
const {rows} = await pool.sql<Todo>(`SELECT ...`)
```

Fichiers

- `exercise/client-pool/page`

### 2. ğŸš€ Variables dâ€™environnement

Les adresses de connexions aux serveurs de base de donnÃ©es varient en fonction de lâ€™environnement

- developpement
- production
- test

Il nâ€™est donc pas conseiller de mettre les informations de connexion dans le code (cela pose Ã©galement des problÃ¨mes de sÃ©curitÃ©).

A la place nous utilisons des variables dâ€™environnements.

- `.env.development`
- `.env.production`

### Ordre de prioritÃ© des fichiers `.env` dans Next.js :

1. **.env.local** : Ce fichier est toujours chargÃ©, quelle que soit l'environnement (`development`, `production`, etc.). Il est utile pour stocker des variables d'environnement spÃ©cifiques Ã  la machine locale, et ce fichier est gÃ©nÃ©ralement ignorÃ© par Git.
2. **.env.development** : Ce fichier est chargÃ© uniquement en mode dÃ©veloppement (`next dev`). Il contient des variables d'environnement spÃ©cifiques au dÃ©veloppement.
3. **.env.production** : Ce fichier est chargÃ© uniquement en mode production (`next start`). Il contient des variables d'environnement spÃ©cifiques Ã  la production.
4. **.env.test** : Ce fichier est chargÃ© uniquement en mode test (`next test` ou lors de l'exÃ©cution de tests).
5. **.env** : Ce fichier est une sorte de "fallback" pour toutes les configurations. S'il n'existe pas de fichier spÃ©cifique Ã  l'environnement actuel, Next.js utilisera les variables dÃ©finies dans ce fichier.

<aside>
ğŸ’¡ La prioritÃ© est toujours faite Ã  la variable dâ€™environnement prÃ©sente sur la machine

</aside>

**ğŸ¶ Dans cet exercice adapte le code pour quâ€™il utilise la bonne variable dâ€™environnement et modifie les fichier .env pour contenir la connexion a ta base de donnÃ©es.**

Fichiers

- `exercise/client-pool/page`
- `.env.development`
- `.env.production`

## Aller plus loin

ğŸ“‘ Le lien vers la doc [https://www.w3schools.com/html/html_css.asp](https://www.w3schools.com/html/html_css.asp)

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=Data%20Modeling&entry.533578441=01%20Client%20Pool).
