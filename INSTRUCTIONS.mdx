# Relation One To Many

### 💡 Description longue de l'exercice

## 📝 Tes notes

Detaille ce que tu as appris ici, sur une page [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Les relations 1-N (One to Many) sont le le type de relation le plus répandu. Ces par exemple

- 1 Panier —> contient N produits
- 1 User —> possède N posts

Dans l’autre sens

- 1 Produit —> appartient à 1 Panier
- 1 Post—> appartient à 1 User

Pour définir ce type de relation avec `Drizzle` il faut définir la relation dans les deux sens. Exemple

```tsx

export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  name: text('name'),
});

export const posts = pgTable('posts', {
  id: serial('id').primaryKey(),
  content: text('content'),
  authorId: integer('author_id'),
});

// avec 'one'
// 1 Post appartients à un user ('one')
export const postsRelations = relations(posts, ({ one }) => ({
  author: one(users, {
    fields: [posts.authorId],
    references: [users.id],
  }),
}));
// avec 'many'
// 1 User possède plusieurs posts ('many')
export const usersRelations = relations(users, ({ many }) => ({
  posts: many(posts),
}));
```

Il est ensuite possible de récupérer “automatiquement” les relations liés avec `with` : exemple

```tsx
const result = await db.query.users.findFirst({
  with: {
    posts: true
  },
});
// va retourner le premier utilisateur trouvé avec tout ses posts associés
// output result :
[{
  id: 1,
  name: "Dan",
  posts: [
    {
      id: 1,
      content: "SQL is awesome",
      authorId: 1,
    },
    {
      id: 2,
      content: "But check relational queries",
      authorId: 1,
    }
  ]
}]
```

## Exercice

Dans cet exercice nous avons repris nos `Products` et `Categories` et nous les avons ajouté a `Drizzle`

```tsx
// src/db/schema/...
export const categories = pgTable('category', {
  id: serial('id').primaryKey(),
  name: text('name'),
})

export const products = pgTable('product', {
  id: serial('id').primaryKey(),
  title: varchar('title', {length: 256}),
  price: real('price'),
  description: text('description'),
  image: varchar('image', {length: 256}),
  category: integer('category_id'),
  quantity: integer('quantity'),
  createdAt: date('createdat'),
  updatedAt: date('updatedat'),
})
```

```tsx
// src/db/schema/index.ts

const db = drizzle(pool, {
  schema: {...todos, ...users, ...categories, ...products},
})
```

**🐶 1. Créer la relation `1 to many` dans les shemas**

**🐶 2. Adapte la requête `getCategoriesByIdWithProducts`**

Constate pour que chaque catégorie nous avons bien plusieurs produits

Fichiers

- `src/db/products`
- `src/db/categories`
- `exercises/one-many/actions`

## Bonus

### 1. 🚀 Imbrication

Dans chaque catégorie nous avons les produits. Le champs `product.category` contient l’id de la catégorie. Or à l’écran nous voulons le nom et nom l’id. Nous voulons donc charger également la relation.

**🐶 Dans cet utilise `with` à l’intérieur du premier `with` pour récupérer les noms de catégories**

```tsx
with: {
    products: {
      with: ... //imbrication
    },
  },
```

Fichiers

- `exercises/one-many/actions`

###

## Aller plus loin

📑 Le lien vers la doc [https://www.w3schools.com/html/html_css.asp](https://www.w3schools.com/html/html_css.asp)

## Ils vont t’aider

- **🐶 Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **🤖 Ash le Robot** : _Ash le Robot te donnera du code utile._
- **🚀 Julia La roquette** : _Julia te donnera des défis supplémentaires._
- **⛏️ Hulk le Marteau** : _Quand du code à supprimer est présent_
- **👨‍✈️ Hugo le chef de projet** : _Va t'aider sur les spécifications du projet_

## 🐜 Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=Data%20Modeling&entry.533578441=07%20One%20to%20many).
