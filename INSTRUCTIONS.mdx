# Drizzle KIT - Génération / Migration

### 💡 Utiliser Drizzle KIT

## 📝 Tes notes

Détaille ce que tu as appris ici, sur une page [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Il est important d’avoir un code base en phase avec la modélisation de notre base de données. Dans les modules précédents, nous avions :

- Des Scripts SQL pour créer notre model de données.
- Notre code base.

S'assurer que tout est en phase peut être fastidieux et l’on n’est jamais à l’abris d’un oubli. Dans une application, il y a à gérer le développement de nouvelle `feature` mais aussi l’évolution.

Comment gérer la suppression, l’ajout ou la modification d’une table, colonne, type ? Cela peut vite devenir compliqué.

### Drizzle Kit

`Drizzle kit` est un utilitaire nous permettant plusieurs choses mais les plus importantes sont :

- La génération du model de données

En gros la conversion de notre code en script SQL

```tsx
export const user = pgTable("user", {
  id: serial("id"),
  name: text("name"),
  email: text("email"),
  password: text("password"),
  role: text("role").$type<"admin" | "customer">(),
  createdAt: timestamp("created_at"),
  updatedAt: timestamp("updated_at"),
});
// tranformer en ça
CREATE TABLE IF NOT EXISTS "user" (
  "id" serial,
  "name" text,
  "email" text,
  "password" text,
  "role" text,
  "created_at" timestamp,
  "updated_at" timestamp
);
```

- La gestion des migrations

C’est à dire les scripts permettant de passer d’une version à une autre.

Admettons l’ajout d’une colonne `isVerified: boolean("is_verified"),`

```tsx
export const user = pgTable("user", {
  id: serial("id"),
  name: text("name"),
  email: text("email"),
  password: text("password"),
  isVerified: boolean("is_verified"),
  role: text("role").$type<"admin" | "customer">(),
  createdAt: timestamp("created_at"),
  updatedAt: timestamp("updated_at"),
});
//generation
ALTER TABLE "user" ADD COLUMN "is_verified" boolean;
```

📑 Le lien vers la doc : [https://orm.drizzle.team/kit-docs/overview#overview](https://orm.drizzle.team/kit-docs/overview#overview)

## Exercice

Dans cet exercice, nous allons créer plusieurs scripts, la première chose est d’ajouter la dépendance vers `drizzle` kit :

```json
//package.json
"devDependencies": {
    "drizzle-kit": "^0.24.0",
```

Ensuite les scripts :

```json
"db:generate": "drizzle-kit generate", //generation des scripts
"db:migrate": "drizzle-kit migrate", //execution des scripts de migration
"db:drop": "drizzle-kit drop", // supression d'un script de migration
"db:reset-seed": "pnpm db:clear && pnpm db:generate && pnpm db:migrate && pnpm db:seed" // Tout renegenerer
```

**🐶** Pour que ces scripts fonctionnent, tu vas créer un fichier de configuration `drizzle`.

Fichiers

- `pacakge.json`
- `drizzle.config.ts`

## Bonus

### 1. 🚀 Studio

Essaie le studio (en beta) :

```json
"db:studio": "drizzle-kit studio" // permet de lancer une interface legere
```

[Se connecter à l’interface](https://local.drizzle.studio/)

Il est intéressant de voir que l’on peut :

- Exécuter des requêtes `SQL`
- Exécuter des requêtes `Drizzle`
- Introspecter les tables dans l’onglet `shema`

Crée une nouvelle table `TOTO` et constate l’introspection :

```sql
CREATE TABLE TOTO (
  id SERIAL PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  isCompleted BOOLEAN NOT NULL,
  createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

Fichiers

- `package.json`

## Aller plus loin

📑 Le lien vers la doc [https://orm.drizzle.team/kit-docs/overview](https://orm.drizzle.team/kit-docs/overview)

## Ils vont t’aider

- **🐶 Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **🤖 Ash le Robot** : _Ash le Robot te donnera du code utile._
- **🚀 Julia La roquette** : _Julia te donnera des défis supplémentaires._
- **⛏️ Hulk le Marteau** : _Quand du code à supprimer est présent_
- **👨‍✈️ Hugo le chef de projet** : _Va t'aider sur les spécifications du projet_

## 🐜 Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=06.Data%20Modeling&entry.533578441=05%20Drizzle%20Kit).
