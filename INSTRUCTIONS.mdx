# Dynamics Queries

### ğŸ’¡ Comprendre les Dynamics Queries

## ğŸ“ Tes notes

Detaille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Dans ce module, nous allons explorer la construction de requÃªtes dynamiques avec `Drizzle` ORM.

Ce concept est essentiel pour les dÃ©veloppeurs qui souhaitent crÃ©er des requÃªtes complexes et Ã©volutives en fonction des besoins spÃ©cifiques de leur application.

En utilisant le mode dynamique de `Drizzle`, vous pouvez contourner les limitations des mÃ©thodes SQL traditionnelles et enrichir vos requÃªtes de maniÃ¨re flexible, en intÃ©grant des fonctionnalitÃ©s comme la pagination ou les jointures Ã  la volÃ©e.

On pourrait par exemple avoir besoin de combiner plusieurs clauses comme ceci, mais le query builder de `Drizzle` se veut etre le plus proche possible de la syntaxe SQL.

```tsx
const query = db
  .select()
  .from(users)
  .where(eq(users.id, 1))
  .where(eq(users.name, 'John')); // âŒ Type error - where() can only be invoked once
```

On pourrait Ã©galement avoir envie de faire

```tsx
const query = db.select().from(users).where(eq(users.id, 1));
// et puis
query.limit(10).offset(50);
// âŒ Type error - the query builder is not in dynamic mode
```

Pour pouvoir faire ceci il existe :

**Dynamic Query Building :**

```tsx
function withFriends<T extends PgSelect>(qb: T) {
  return qb.leftJoin(friends, eq(friends.userId, users.id));
}
let query = db.select().from(users).where(eq(users.id, 1)).$dynamic();
query = withFriends(query);
```

ğŸ“‘ Le liens vers la doc [https://orm.drizzle.team/docs/dynamic-query-building](https://orm.drizzle.team/docs/dynamic-query-building)

## Exercice

Dans cet exercice tu vas devoir utiliser les **Dynamic Query** pour gÃ©rer la pagination. En effet la pagination est une structure qui peut Ãªtre rÃ©utilisÃ© partout dans le code, avoir une fonction commune `withPagination` nous permet dâ€™avoir une seule structure de pagination dans notre code.

NOTE : Cela fonctionne uniquement avec les requÃªte â€˜Selectâ€™,

```tsx
const result = await db.select().from(users);
```

Cela **ne fonctionne pas** avec les requÃªtes relationnel

```tsx
const result = await db.query.users.findMany({
  with: {
    posts: true
  },
});
// NE FONCTIONNE PAS AVEC LES DYNAMIC QUERY
```

NOTE 2 :

Les requÃªtes relationnelles (`query`) retourne un rÃ©sultat imbriquÃ©

```tsx
row[0].product.category.name
```

Les requÃªtes SELECT avec jointures retourne les donnÃ©es a plat

```tsx
row[0].product
row[0].category
```

Pour Ã©viter dâ€™avoir a changer toute la structure de notre page / tables / form, nous utiliser une fonction qui transforme une format plat en format imbriquÃ©

```tsx
 transformFlattenedData(resultQuery as FlattenedData[]),
```

- **ğŸ¶ ImplÃ©mente** `withPagination` **dans lâ€™action**

Fichiers

- `exercises/dynamic-query/action.ts`

## Bonus

### 1. ğŸš€ Composition

Il est possible de composer nos requÃªte dynamique.

**ğŸ¶ CrÃ©Ã© de nouvelles fonctions**

- `withOrderBy` qui sâ€™occupe du trie
- `withCategories` qui sâ€™occupe de la jointure de category

Te que lâ€™on puisse appeler

```tsx
const query = db.select().from(products)

const dynamicQueryProduct = query.$dynamic()
const dynamicQueryCat = withCategories(dynamicQueryProduct).$dynamic()
const dynamicQuery = withOrderBy(dynamicQueryCat).$dynamic()
const resultQuery = await withPagination(dynamicQuery, start, nbElement)
```

Ou bien en inline

```tsx
  const resultQuery = await withPagination(
    withOrderBy(
      withCategories(db.select().from(products).$dynamic()).$dynamic()
    ).$dynamic(),
    start,
    nbElement
  )
```

Fichiers

- `exercises/dynamic-query/action.ts`

###

## Aller plus loin

ğŸ“‘ Le lien vers la doc [https://orm.drizzle.team/docs/dynamic-query-building](https://orm.drizzle.team/docs/dynamic-query-building)

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=Data%20Modeling&entry.533578441=11%20Dynamic%20Query).
